<p-toast />
<main>
  <p-toolbar>
    <ng-template #start>
      <section class="flex space-x-4">
        <p-iconfield iconPosition="left">
          <p-inputicon class="pi pi-search" />
          <input
            [(ngModel)]="searchText"
            type="text"
            placeholder="ID / nº série produto / cliente..."
            pInputText
            class="w-96"
          />
        </p-iconfield>
        <p-button
          [outlined]="true"
          [rounded]="true"
          severity="primary"
          label="Pesquisar"
          (click)="onPesquisar()"
        ></p-button>
        @if (searchText.length > 0) {
          <p-button
            [outlined]="true"
            [rounded]="true"
            severity="secondary"
            label="Limpar Busca"
            icon="pi pi-times-circle"
            (click)="onLimparPesquisa()"
          ></p-button>
        }
        <div class="flex items-center gap-2">
          <p-toggleswitch [(ngModel)]="apenasEmProgresso" size="small" />
          <span class="text-center text-sm font-semibold text-primary">Apenas Em Andamento</span>
        </div>
      </section>
    </ng-template>
    <ng-template #end>
      <p-button label="Cadastrar Serviço" (click)="irParaCadastro()" icon="pi pi-plus"></p-button>
    </ng-template>
  </p-toolbar>

  <p-tabs [(value)]="abaAtual">
    <p-tablist>
      <p-tab [value]="0">Serviços</p-tab>
      <p-tab [value]="1">Cadastrar Serviço</p-tab>
      @for (servicoEdit of servicosEdit; track servicoEdit.id; let index = $index) {
        <p-tab [value]="index + 2"
          >Serviço #{{ servicoEdit.id }}
          <p-button
            icon="pi pi-times"
            severity="danger"
            [text]="true"
            [style]="{
              width: '0.5rem',
              height: '0.5rem',
              padding: '0.6rem',
              marginLeft: '0.5rem',
            }"
            (click)="fecharAba(index, { reload: false })"
        /></p-tab>
      }
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel [value]="0">
        <div class="flex flex-col">
          <!-- Aba de Serviços -->
          <div class="flex gap-4 flex-wrap pb-4">
            @if (servicos.length > 0) {
              @for (servico of servicos; track servico.id) {
                <p-card [style]="{ width: '25rem' }">
                  <ng-template #header>
                    <section class="w-full pt-2 flex justify-between px-4">
                      <div class="flex-1 pr-2">
                        <p-message
                          styleClass="w-full bg-red"
                          size="small"
                          [severity]="servico.status === finalizadoStatusId ? 'success' : 'info'"
                          >{{ getStatusLabel(servico.status) }}
                          {{
                            servico.status === finalizadoStatusId
                              ? `em ${(servico.dataFim | date: 'dd/MM/yyyy')}`
                              : ''
                          }}</p-message
                        >
                      </div>
                      @if (!(servico.status === finalizadoStatusId)) {
                        <p-button
                          icon="pi pi-check"
                          [outlined]="true"
                          severity="success"
                          (click)="onConcluirServico(servico)"
                          [rounded]="true"
                          size="small"
                        ></p-button>
                      }
                    </section>
                  </ng-template>
                  <ng-template #title>
                    <section class="flex justify-between items-center">
                      <div class="flex items-center">
                        <p-avatar icon="pi pi-cog" class="mr-2" size="large" shape="circle" />
                        <div class="flex flex-col">
                          <span class="text-primary font-bold">Serviço #{{ servico.id }}</span>
                          <span class="text-primary-400 text-sm"
                            >Valor: {{ servico.valor | currency: 'BRL' }}</span
                          >
                        </div>
                      </div>
                      <p-button
                        icon="pi pi-pen-to-square"
                        [text]="true"
                        severity="secondary"
                        (click)="onEditarServico(servico)"
                        [rounded]="true"
                      ></p-button>
                    </section>
                  </ng-template>
                  <section class="flex flex-col w-full">
                    <h3><strong>Produto:</strong> {{ servico.produto.numeroSerie }}</h3>
                    @if (servico?.pessoa) {
                      <h3><strong>Cliente:</strong> {{ servico.pessoa.nome }}</h3>
                    } @else {
                      <h3 class="text-neutral-500 font-semibold">
                        Atenção! Esse é um serviço interno
                      </h3>
                    }
                    <h3>
                      <strong>Data de Início:</strong>
                      {{ servico.dataInicio | date: 'dd/MM/yyyy' }}
                    </h3>

                    @if (servico.observacoes) {
                      <p-fieldset legend="Notas do Serviço">
                        <div class="p-0">
                          {{ servico.observacoes | truncate: 75 }}
                        </div>
                      </p-fieldset>
                      @if (servico.observacoes.length > 75) {
                        <p class="text-sm text-neutral-500 font-semibold">
                          Para ver o resto das observações, clique para editar!
                        </p>
                      }
                    }
                  </section>
                </p-card>
              }
            } @else {
              <p-card
                [header]="
                  searchText.length <= 0
                    ? 'Não há serviços cadastrados!'
                    : 'Não foram encontrados serviços com base nessa pesquisa.'
                "
                class="w-full"
              >
                <p class="m-0">
                  {{
                    searchText.length <= 0
                      ? 'Comece a adicionar serviços no sistema para vê-los aqui!'
                      : 'Modifique seus parâmetros de busca e tente novamente!'
                  }}
                </p>
              </p-card>
            }
          </div>
          @if (servicos.length > 0) {
            <div class="flex justify-center pt-4">
              <p-paginator
                [rows]="itensPorPagina"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="{totalRecords} serviços"
                [totalRecords]="totalRegistros"
                [rowsPerPageOptions]="[6, 8, 10]"
                (onPageChange)="onPageChange($event)"
              ></p-paginator>
            </div>
          }
        </div>
      </p-tabpanel>
      <p-tabpanel [value]="1">
        <!-- Aba do Formulario de Cadastrar -->
        <app-formulario-servicos (fecharAba)="fecharAba(-1, $event)"></app-formulario-servicos>
      </p-tabpanel>
      @for (servicoEdit of servicosEdit; track servicoEdit.id; let index = $index) {
        <p-tabpanel [value]="index + 2">
          <app-formulario-servicos
            [servicoEdicao]="servicoEdit"
            (fecharAba)="fecharAba(index, $event)"
          ></app-formulario-servicos>
        </p-tabpanel>
      }
    </p-tabpanels>
  </p-tabs>
</main>
