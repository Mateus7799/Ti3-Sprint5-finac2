<p-dialog
  [header]="'Histórico do Produto ' + (produto?.numeroSerie || '')"
  [modal]="true"
  [(visible)]="visible"
  [draggable]="false"
  [style]="{ width: '70rem', maxHeight: '80vh' }"
  (onHide)="fecharModal()"
>
  @if (carregando) {
    <div class="flex justify-center items-center py-8">
      <p-message severity="info" size="small">Carregando histórico...</p-message>
    </div>
  } @else {
    @if (historico.length > 0) {
      <div class="flex flex-col gap-4 max-h-96 overflow-y-auto">
        @for (item of historico; track item.data) {
          <p-card
            [ngClass]="{
              'border-l-4 border-green-500': item.label === 'Venda',
              'border-l-4 border-red-500': item.label === 'Compra'
            }"
          >
            <ng-template #title>
              <section class="flex justify-between items-center">
                <div class="flex items-center">
                  <p-avatar
                    [icon]="item.dataFim ? 'pi pi-wrench' : 'pi pi-dollar'"
                    class="mr-2"
                    size="large"
                    shape="circle"
                  />
                  <div class="flex flex-col">
                    <span class="font-bold text-primary">{{ item.label }}</span>
                    @if (item.pessoa) {
                      <span class="text-sm text-neutral-500">{{ item.pessoa.nome }}</span>
                    }
                  </div>
                </div>
                <p-message [severity]="getSeveridadeLabel(item.label)" size="small">
                  {{ item.label }}
                </p-message>
              </section>
            </ng-template>
            <div class="flex justify-between text-sm">
              <div>
                @if (item.pessoa) {
                  <p><strong>Cliente:</strong> {{ item.pessoa.nome }}</p>
                  <p><strong>CPF/CNPJ:</strong> {{ item.pessoa.cpfCnpj }}</p>
                }
                @if (item.funcionario) {
                  <p><strong>Funcionário:</strong> {{ item.funcionario.nome }}</p>
                }
              </div>
              <div class="text-end">
                <p><strong>Data:</strong> {{ item.data | date: 'dd/MM/yyyy' }}</p>
                @if (item.dataFim) {
                  <p><strong>Data Fim:</strong> {{ item.dataFim | date: 'dd/MM/yyyy' }}</p>
                }
                <p
                  [ngClass]="{
                    'text-green-600': item.label === 'Venda',
                    'text-red-600': item.label === 'Compra',
                    'text-orange-600': item.label === 'Troca',
                    'text-blue-600': item.label !== 'Venda' && item.label !== 'Compra' && item.label !== 'Troca'
                  }"
                >
                  <strong>Valor:</strong> {{ item.valor | currency: 'BRL' }}
                </p>
              </div>
            </div>
          </p-card>
        }
      </div>
    } @else {
      <p-card header="Nenhum histórico encontrado">
        <p class="m-0">Este produto ainda não possui operações ou serviços registrados.</p>
      </p-card>
    }
  }
  <div class="flex justify-end pt-4">
    <p-button label="Fechar" severity="primary" [outlined]="true" (click)="fecharModal()"></p-button>
  </div>
</p-dialog>
