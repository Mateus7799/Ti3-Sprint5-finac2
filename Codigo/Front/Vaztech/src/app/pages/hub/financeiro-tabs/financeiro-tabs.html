<p-toast />

<main class="flex flex-col gap-6 p-6">
  <!-- Cards do Mês Atual -->
  <header class="flex justify-between items-center w-full">
    <h2 class="text-2xl font-bold text-primary">
      @if (!!dadosVisaoGeral) {
        Visão Geral de {{ dadosVisaoGeral?.faturamento?.ano ?? '...' }}
      } @else {
        Resumo - {{ getNomeMes(dadosMesAtual?.mes || 0) }}/{{ dadosMesAtual?.ano }}
      }
    </h2>
    <div class="flex gap-3">
      <div class="flex gap-3">
        <p-select
          inputId="mes-selector"
          [(ngModel)]="mesSelecionado"
          [options]="mesesDisponiveisVisaoGeral"
          optionLabel="nome"
          optionValue="valor"
          placeholder="Selecione o mês"
          [scrollHeight]="'200px'"
          appendTo="body"
        />
        <span class="flex items-center justify-center text-center">de</span>
        <p-select
          inputId="ano-selector"
          [(ngModel)]="anoSelecionado"
          [options]="anosDisponiveis"
          placeholder="Selecione o ano"
          [scrollHeight]="'200px'"
          appendTo="body"
        />
        <p-button
          [label]="vendoVisaoGeral ? 'Visualizar Relatório' : 'Selecionar Mês'"
          icon="pi pi-calendar"
          (click)="confirmarSelecaoMes()"
          [disabled]="!anoSelecionado || !mesSelecionado"
          [outlined]="true"
        />
      </div>
      <p-button label="Comparar Meses" icon="pi pi-chart-bar" (click)="abrirModalComparacao()" />
    </div>
  </header>

  <div class="flex justify-between items-center w-full">
    @if (dadosMesAtual) {
      <div class="flex flex-col w-full gap-6">
        @if (dadosMesAtual) {
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Card Faturamento -->
            <p-card styleClass="shadow-md border-4 border-green-200">
              <ng-template #header>
                <div class="flex items-center gap-3 rounded-t-lg p-4 bg-green-50">
                  <i class="pi pi-dollar text-3xl text-green-600"></i>
                  <div>
                    <h3 class="text-lg font-semibold text-green-800">Faturamento</h3>
                    <p class="text-sm text-green-600">Total de Vendas</p>
                  </div>
                </div>
              </ng-template>
              <div class="text-center py-4">
                <p class="text-3xl font-bold text-green-700">
                  {{ dadosMesAtual.faturamento | currency: 'BRL' }}
                </p>
              </div>
            </p-card>

            <!-- Card Custo -->
            <p-card styleClass="shadow-md border-4 border-red-200">
              <ng-template #header>
                <div class="flex items-center gap-3 rounded-t-lg p-4 bg-red-50">
                  <i class="pi pi-shopping-cart text-3xl text-red-600"></i>
                  <div>
                    <h3 class="text-lg font-semibold text-red-800">Custo</h3>
                    <p class="text-sm text-red-600">Total de Compras</p>
                  </div>
                </div>
              </ng-template>
              <div class="text-center py-4">
                <p class="text-3xl font-bold text-red-700">
                  {{ dadosMesAtual.custo | currency: 'BRL' }}
                </p>
              </div>
            </p-card>

            <!-- Card Lucro -->
            <p-card styleClass="shadow-md border-4 border-blue-200">
              <ng-template #header>
                <div class="flex items-center rounded-t-md gap-3 p-4 bg-blue-50">
                  <i class="pi pi-chart-line text-3xl text-blue-600"></i>
                  <div>
                    <h3 class="text-lg font-semibold text-blue-800">Lucro</h3>
                    <p class="text-sm text-blue-600">Faturamento - Custo</p>
                  </div>
                </div>
              </ng-template>
              <div class="text-center py-4">
                <p
                  class="text-3xl font-bold"
                  [ngClass]="{
                    'text-blue-700': dadosMesAtual.lucro >= 0,
                    'text-red-700': dadosMesAtual.lucro < 0,
                  }"
                >
                  {{ dadosMesAtual.lucro | currency: 'BRL' }}
                </p>
              </div>
            </p-card>
          </div>
        } @else {
          <div class="flex justify-center items-center py-12">
            <p-progressSpinner />
          </div>
        }
        <!-- Cards do Mês Anterior -->
        @if (dadosMesAnterior) {
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-primary">
              Resumo - {{ getNomeMes(dadosMesAnterior?.mes || 0) }}/{{ dadosMesAnterior?.ano }}
            </h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Card Faturamento -->
            <p-card styleClass="shadow-md border-4 border-green-200">
              <ng-template #header>
                <div class="flex items-center gap-3 rounded-t-lg p-4 bg-green-50">
                  <i class="pi pi-dollar text-3xl text-green-600"></i>
                  <div>
                    <h3 class="text-lg font-semibold text-green-800">Faturamento</h3>
                    <p class="text-sm text-green-600">Total de Vendas</p>
                  </div>
                </div>
              </ng-template>
              <div class="text-center py-4">
                <p class="text-3xl font-bold text-green-700">
                  {{ dadosMesAnterior.faturamento | currency: 'BRL' }}
                </p>
              </div>
            </p-card>

            <!-- Card Custo -->
            <p-card styleClass="shadow-md border-4 border-red-200">
              <ng-template #header>
                <div class="flex items-center gap-3 rounded-t-lg p-4 bg-red-50">
                  <i class="pi pi-shopping-cart text-3xl text-red-600"></i>
                  <div>
                    <h3 class="text-lg font-semibold text-red-800">Custo</h3>
                    <p class="text-sm text-red-600">Total de Compras</p>
                  </div>
                </div>
              </ng-template>
              <div class="text-center py-4">
                <p class="text-3xl font-bold text-red-700">
                  {{ dadosMesAnterior.custo | currency: 'BRL' }}
                </p>
              </div>
            </p-card>

            <!-- Card Lucro -->
            <p-card styleClass="shadow-md border-4 border-blue-200">
              <ng-template #header>
                <div class="flex items-center rounded-t-md gap-3 p-4 bg-blue-50">
                  <i class="pi pi-chart-line text-3xl text-blue-600"></i>
                  <div>
                    <h3 class="text-lg font-semibold text-blue-800">Lucro</h3>
                    <p class="text-sm text-blue-600">Faturamento - Custo</p>
                  </div>
                </div>
              </ng-template>
              <div class="text-center py-4">
                <p
                  class="text-3xl font-bold"
                  [ngClass]="{
                    'text-blue-700': dadosMesAnterior.lucro >= 0,
                    'text-red-700': dadosMesAnterior.lucro < 0,
                  }"
                >
                  {{ dadosMesAnterior.lucro | currency: 'BRL' }}
                </p>
              </div>
            </p-card>
          </div>
        } @else {
          <div class="flex justify-center items-center py-12">
            <p-progressSpinner />
          </div>
        }
      </div>
    } @else if (dadosVisaoGeral) {
      <div class="flex flex-col w-full">
        <h2 class="text-lg text-neutral-400 font-semibold">
          Clique nos quadradinhos para habilitar/desabilitar algum gráfico!
        </h2>
        <div class="flex w-full justify-center items-center max-h-96 h-96">
          <p-chart type="line" [data]="infoGrafico" [options]="optsGrafico" class="w-3/4" />
        </div>
        <h3 class="text-lg text-neutral-400 py-3 font-semibold">
          Aqui temos mais algumas estatísticas sobre o ano de
          {{ dadosVisaoGeral?.faturamento?.ano }}:
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Card Faturamento -->
          <p-card styleClass="shadow-md border-4 border-green-200">
            <ng-template #header>
              <div class="flex items-center gap-3 rounded-t-lg p-4 bg-green-50">
                <i class="pi pi-dollar text-3xl text-green-600"></i>
                <div>
                  <h3 class="text-lg font-semibold text-green-800">
                    Faturamento total de {{ dadosVisaoGeral?.faturamento?.ano }}
                  </h3>
                  <p class="text-sm text-green-600">Total de Vendas</p>
                </div>
              </div>
            </ng-template>
            <div class="text-center py-4">
              <p class="text-3xl font-bold text-green-700">
                {{ dadosVisaoGeral?.faturamento?.faturamentoTotalAnual | currency: 'BRL' }}
              </p>
            </div>
          </p-card>

          <!-- Card Custo -->
          <p-card styleClass="shadow-md border-4 border-red-200">
            <ng-template #header>
              <div class="flex items-center gap-3 rounded-t-lg p-4 bg-red-50">
                <i class="pi pi-shopping-cart text-3xl text-red-600"></i>
                <div>
                  <h3 class="text-lg font-semibold text-red-800">
                    Custo total de {{ dadosVisaoGeral?.custo?.ano }}
                  </h3>
                  <p class="text-sm text-red-600">Total de Compras</p>
                </div>
              </div>
            </ng-template>
            <div class="text-center py-4">
              <p class="text-3xl font-bold text-red-700">
                {{ dadosVisaoGeral?.custo?.custoTotalAnual | currency: 'BRL' }}
              </p>
            </div>
          </p-card>

          <!-- Card Lucro -->
          <p-card styleClass="shadow-md border-4 border-blue-200">
            <ng-template #header>
              <div class="flex items-center rounded-t-md gap-3 p-4 bg-blue-50">
                <i class="pi pi-chart-line text-3xl text-blue-600"></i>
                <div>
                  <h3 class="text-lg font-semibold text-blue-800">
                    Lucro total de {{ dadosVisaoGeral?.lucro?.ano }}
                  </h3>
                  <p class="text-sm text-blue-600">Faturamento - Custo</p>
                </div>
              </div>
            </ng-template>
            <div class="text-center py-4">
              <p
                class="text-3xl font-bold"
                [ngClass]="{
                  'text-blue-700': dadosVisaoGeral?.lucro?.lucroTotalAnual ?? 0 >= 0,
                  'text-red-700': dadosVisaoGeral?.lucro?.lucroTotalAnual ?? 0 < 0,
                }"
              >
                {{ dadosVisaoGeral?.lucro?.lucroTotalAnual | currency: 'BRL' }}
              </p>
            </div>
          </p-card>
        </div>
      </div>
    } @else {
      <div class="flex justify-center items-center py-12">
        <p-progressSpinner />
      </div>
    }
  </div>

  <!-- Modal Seletor de Mês -->
  <!-- <p-dialog -->
  <!--   header="Selecionar Mês" -->
  <!--   [(visible)]="modalSeletorMesAberto" -->
  <!--   [modal]="true" -->
  <!--   [style]="{ width: '30rem' }" -->
  <!--   [draggable]="false" -->
  <!-- > -->
  <!--   <div class="flex flex-col gap-4"> -->
  <!--     <div class="flex flex-col gap-2"> -->
  <!--       <label for="ano-selector" class="font-semibold">Ano</label> -->
  <!--       <p-select -->
  <!--         inputId="ano-selector" -->
  <!--         [(ngModel)]="anoSelecionado" -->
  <!--         [options]="anosDisponiveis" -->
  <!--         placeholder="Selecione o ano" -->
  <!--         [scrollHeight]="'200px'" -->
  <!--         appendTo="body" -->
  <!--       /> -->
  <!--     </div> -->
  <!---->
  <!--     <div class="flex flex-col gap-2"> -->
  <!--       <label for="mes-selector" class="font-semibold">Mês</label> -->
  <!--       <p-select -->
  <!--         inputId="mes-selector" -->
  <!--         [(ngModel)]="mesSelecionado" -->
  <!--         [options]="mesesDisponiveisVisaoGeral" -->
  <!--         optionLabel="nome" -->
  <!--         optionValue="valor" -->
  <!--         placeholder="Selecione o mês" -->
  <!--         [scrollHeight]="'200px'" -->
  <!--         appendTo="body" -->
  <!--       /> -->
  <!--     </div> -->
  <!--   </div> -->
  <!---->
  <!--   <ng-template #footer> -->
  <!--     <div class="flex justify-end gap-2"> -->
  <!--       <p-button -->
  <!--         label="Cancelar" -->
  <!--         severity="secondary" -->
  <!--         [outlined]="true" -->
  <!--         (click)="modalSeletorMesAberto = false" -->
  <!--       /> -->
  <!--       <p-button -->
  <!--         label="Confirmar" -->
  <!--         (click)="confirmarSelecaoMes()" -->
  <!--         [disabled]="!anoSelecionado || !mesSelecionado" -->
  <!--       /> -->
  <!--     </div> -->
  <!--   </ng-template> -->
  <!-- </p-dialog> -->

  <!-- Modal Comparação de Meses -->
  <p-dialog
    header="Comparar Meses"
    [(visible)]="modalComparacaoAberto"
    [modal]="true"
    [style]="{ width: '60rem', maxWidth: '90vw' }"
    [draggable]="false"
  >
    <div class="flex flex-col gap-6">
      <!-- Seletores de Meses -->
      <div class="grid grid-cols-2 gap-6">
        <!-- Primeiro Mês -->
        <div class="flex flex-col gap-3 p-4 border-2 border-gray-200 rounded-lg">
          <h3 class="font-semibold text-lg text-primary">Primeiro Mês</h3>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Ano</label>
            <p-select
              [(ngModel)]="comparacao.ano1"
              [options]="anosDisponiveis"
              placeholder="Selecione o ano"
              [scrollHeight]="'200px'"
              appendTo="body"
            />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Mês</label>
            <p-select
              [(ngModel)]="comparacao.mes1"
              [options]="mesesDisponiveis"
              optionLabel="nome"
              optionValue="valor"
              placeholder="Selecione o mês"
              [scrollHeight]="'200px'"
              appendTo="body"
            />
          </div>
        </div>

        <!-- Segundo Mês -->
        <div class="flex flex-col gap-3 p-4 border-2 border-gray-200 rounded-lg">
          <h3 class="font-semibold text-lg text-primary">Segundo Mês</h3>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Ano</label>
            <p-select
              [(ngModel)]="comparacao.ano2"
              [options]="anosDisponiveis"
              placeholder="Selecione o ano"
              [scrollHeight]="'200px'"
              appendTo="body"
            />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Mês</label>
            <p-select
              [(ngModel)]="comparacao.mes2"
              [options]="mesesDisponiveis"
              optionLabel="nome"
              optionValue="valor"
              placeholder="Selecione o mês"
              [scrollHeight]="'200px'"
              appendTo="body"
            />
          </div>
        </div>
      </div>

      <div class="flex justify-center">
        <p-button
          label="Comparar"
          icon="pi pi-chart-bar"
          (click)="realizarComparacao()"
          [disabled]="!comparacao.ano1 || !comparacao.mes1 || !comparacao.ano2 || !comparacao.mes2"
        />
      </div>

      <!-- Resultado da Comparação -->
      @if (dadosComparacao) {
        <p-divider />

        <div class="grid grid-cols-2 gap-6">
          <!-- Dados Mês 1 -->
          <div class="flex flex-col gap-3">
            <h3 class="font-semibold text-lg text-center text-primary">
              {{ getNomeMes(dadosComparacao.mes1.mes) }}/{{ dadosComparacao.mes1.ano }}
            </h3>

            <p-card styleClass="shadow-sm border border-green-200">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">Faturamento</span>
                <span class="text-lg font-bold text-green-700">
                  {{ dadosComparacao.mes1.faturamento | currency: 'BRL' }}
                </span>
              </div>
            </p-card>

            <p-card styleClass="shadow-sm border border-red-200">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">Custo</span>
                <span class="text-lg font-bold text-red-700">
                  {{ dadosComparacao.mes1.custo | currency: 'BRL' }}
                </span>
              </div>
            </p-card>

            <p-card styleClass="shadow-sm border border-blue-200">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">Lucro</span>
                <span
                  class="text-lg font-bold"
                  [ngClass]="{
                    'text-blue-700': dadosComparacao.mes1.lucro >= 0,
                    'text-red-700': dadosComparacao.mes1.lucro < 0,
                  }"
                >
                  {{ dadosComparacao.mes1.lucro | currency: 'BRL' }}
                </span>
              </div>
            </p-card>
          </div>

          <!-- Dados Mês 2 -->
          <div class="flex flex-col gap-3">
            <h3 class="font-semibold text-lg text-center text-primary">
              {{ getNomeMes(dadosComparacao.mes2.mes) }}/{{ dadosComparacao.mes2.ano }}
            </h3>

            <p-card styleClass="shadow-sm border border-green-200">
              <div class="flex justify-between items-center">
                <span class="text-sm w-1/3 font-medium text-gray-600">Faturamento</span>
                <span
                  class="text-sm w-1/3 text-center"
                  [ngClass]="{
                    'text-green-600': dadosComparacao.diferencaPercentual.faturamento > 0,
                    'text-red-600': dadosComparacao.diferencaPercentual.faturamento < 0,
                    'text-gray-600': dadosComparacao.diferencaPercentual.faturamento === 0,
                  }"
                >
                  {{ dadosComparacao.diferencaPercentual.faturamento > 0 ? '+' : ''
                  }}{{ dadosComparacao.diferencaPercentual.faturamento | number: '1.2-2' }}%
                </span>
                <span class="text-lg text-end font-bold w-1/3 text-green-700">
                  {{ dadosComparacao.mes2.faturamento | currency: 'BRL' }}
                </span>
              </div>
            </p-card>

            <p-card styleClass="shadow-sm border border-red-200">
              <div class="flex justify-between items-center">
                <span class="text-sm w-1/3 font-medium text-gray-600">Custo</span>
                <span
                  class="text-sm w-1/3 text-center"
                  [ngClass]="{
                    'text-red-600': dadosComparacao.diferencaPercentual.custo > 0,
                    'text-green-600': dadosComparacao.diferencaPercentual.custo < 0,
                    'text-gray-600': dadosComparacao.diferencaPercentual.custo === 0,
                  }"
                >
                  {{ dadosComparacao.diferencaPercentual.custo > 0 ? '+' : ''
                  }}{{ dadosComparacao.diferencaPercentual.custo | number: '1.2-2' }}%
                </span>
                <span class="text-lg w-1/3 text-end font-bold text-red-700">
                  {{ dadosComparacao.mes2.custo | currency: 'BRL' }}
                </span>
              </div>
            </p-card>

            <p-card styleClass="shadow-sm border border-blue-200">
              <div class="flex justify-between items-center">
                <span class="text-sm w-1/3 font-medium text-gray-600">Lucro</span>
                <span
                  class="text-sm w-1/3 text-center"
                  [ngClass]="{
                    'text-green-600': dadosComparacao.diferencaPercentual.lucro > 0,
                    'text-red-600': dadosComparacao.diferencaPercentual.lucro < 0,
                    'text-gray-600': dadosComparacao.diferencaPercentual.lucro === 0,
                  }"
                >
                  {{ dadosComparacao.diferencaPercentual.lucro > 0 ? '+' : ''
                  }}{{ dadosComparacao.diferencaPercentual.lucro | number: '1.2-2' }}%
                </span>

                <span
                  class="text-lg w-1/3 text-end font-bold"
                  [ngClass]="{
                    'text-blue-700': dadosComparacao.mes2.lucro >= 0,
                    'text-red-700': dadosComparacao.mes2.lucro < 0,
                  }"
                >
                  {{ dadosComparacao.mes2.lucro | currency: 'BRL' }}
                </span>
              </div>
            </p-card>
          </div>
        </div>
      }
    </div>

    <ng-template #footer>
      <div class="flex justify-end">
        <p-button label="Fechar" severity="secondary" (click)="fecharModalComparacao()" />
      </div>
    </ng-template>
  </p-dialog>
</main>
